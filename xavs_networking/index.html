<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>XAVS Networking</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Cockpit API -->
  <script src="../base1/cockpit.js"></script>

  <!-- Styles -->
  <link href="style.theme.css" rel="stylesheet">
  <link rel="stylesheet" href="fontawesome/css/all.css" />
</head>
<body>
  <div class="app">
    <div class="topbar">
      <h1 class="app-title"><i class="fas fa-network-wired"></i> XAVS Networking</h1>
    </div>

      <ul class="nav-tabs" id="tabs">
        <li><a class="nav-link active" data-target="panel-interfaces" data-tab="interfaces">
          <i class="fas fa-network-wired"></i> Interfaces
        </a></li>
        <li><a class="nav-link" data-target="panel-constructs" data-tab="constructs">
          <i class="fas fa-project-diagram"></i> VLAN / Bridge / Bond
        </a></li>
        <li><a class="nav-link" data-target="panel-routes" data-tab="routes">
          <i class="fas fa-route"></i> Routes
        </a></li>
        <li><a class="nav-link" data-target="panel-diagnostics" data-tab="diagnostics">
          <i class="fas fa-stethoscope"></i> Diagnostics
        </a></li>
      </ul>

    <main class="tab-content">
      <!-- Interfaces -->
      <section id="panel-interfaces" class="tab-pane active">
        <div class="toolbar">
          <div class="search">
            <input id="search-iface" placeholder="Search interfaces..." />
          </div>
          <div class="spacer"></div>
          <div class="quick-actions">
            <button id="btn-refresh-interfaces" class="btn btn-outline-brand">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button id="btn-show-netplan" class="btn btn-outline-muted">
              <i class="fas fa-file-alt"></i> Show Config
            </button>
            <button id="btn-apply-netplan" class="btn btn-outline-muted">
              <i class="fas fa-bolt"></i> Apply Config
            </button>
            <button id="btn-backup-netplan" class="btn btn-outline-muted">
              <i class="fas fa-save"></i> Backup
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table" id="table-interfaces">
            <thead>
              <tr>
                <th class="sortable" data-sort="device" title="Click to sort by device name"><i class="fas fa-network-wired"></i> Device</th>
                <th class="sortable" data-sort="type" title="Click to sort by interface type"><i class="fas fa-tag"></i> Type</th>
                <th class="sortable" data-sort="state" title="Click to sort by interface state"><i class="fas fa-chart-bar"></i> State</th>
                <th class="sortable" data-sort="mac" title="Click to sort by MAC address"><i class="fas fa-fingerprint"></i> MAC</th>
                <th class="sortable" data-sort="ipv4" title="Click to sort by IPv4 address"><i class="fas fa-globe"></i> IPv4</th>
                <th class="sortable" data-sort="ipv6" title="Click to sort by IPv6 address"><i class="fas fa-globe"></i> IPv6</th>
                <th class="sortable" data-sort="mtu" title="Click to sort by MTU value"><i class="fas fa-ruler"></i> MTU</th>
                <th title="Available actions for this interface"><i class="fas fa-cog"></i> Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- VLAN/Bridge/Bond -->
      <section id="panel-constructs" class="tab-pane">
        <div class="toolbar">
          <div class="left">
            <button id="btn-import-config" class="btn btn-outline-muted">
              <i class="fas fa-upload"></i> Import Config
            </button>
            <button id="btn-export-config" class="btn btn-outline-muted">
              <i class="fas fa-download"></i> Export Config
            </button>
          </div>
          <div class="right">
            <button id="btn-reset-forms" class="btn btn-outline-muted">
              <i class="fas fa-undo"></i> Reset Forms
            </button>
          </div>
        </div>
        
        <div class="grid">
          <!-- VLAN -->
          <div class="card">
            <h3><i class="fas fa-tags"></i> Create VLAN</h3>
            <label><i class="fas fa-network-wired"></i> Parent Interface
              <select id="vlan-parent" required></select>
            </label>
            <label><i class="fas fa-hashtag"></i> VLAN ID
              <input id="vlan-id" type="number" min="1" max="4094" required placeholder="10">
            </label>
            <label><i class="fas fa-tag"></i> Interface Name (optional)
              <input id="vlan-name" type="text" pattern="[a-zA-Z0-9_.-]+" placeholder="eth0.10">
            </label>
            <div class="advanced-options">
              <details>
                <summary><i class="fas fa-cog"></i> Advanced Options</summary>
                <label><i class="fas fa-ruler"></i> MTU
                  <input id="vlan-mtu" type="number" min="68" max="9000" placeholder="1500">
                </label>
                <label><i class="fas fa-globe"></i> Static IP (optional)
                  <input id="vlan-static-ip" placeholder="192.168.1.10/24">
                </label>
                <label><i class="fas fa-door-open"></i> Gateway (optional)
                  <input id="vlan-gateway" placeholder="192.168.1.1">
                </label>
              </details>
            </div>
            <button id="btn-create-vlan" class="btn btn-brand">
              <i class="fas fa-plus"></i> Create VLAN
            </button>
            <pre id="vlan-out" class="out"></pre>
          </div>

          <!-- Bridge -->
          <div class="card">
            <h3><i class="fas fa-bridge"></i> Create Bridge</h3>
            <label><i class="fas fa-tag"></i> Bridge Name
              <input id="br-name" type="text" required pattern="[a-zA-Z0-9_.-]+" placeholder="br0">
            </label>
            <label><i class="fas fa-network-wired"></i> Port Interfaces
              <input id="br-ports-filter" type="text" placeholder="Filter interfaces..." style="margin-bottom: 0.5rem;">
              <select id="br-ports" multiple required style="height:100px;"></select>
            </label>
            <div class="advanced-options">
              <details>
                <summary><i class="fas fa-cog"></i> Advanced Options</summary>
                <label><i class="fas fa-tree"></i> STP (Spanning Tree Protocol)
                  <select id="br-stp">
                    <option value="true">✓ Enable</option>
                    <option value="false" selected">❌ Disable</option>
                  </select>
                </label>
                <label><i class="fas fa-clock"></i> Forward Delay (seconds)
                  <input id="br-forward-delay" type="number" min="2" max="30" placeholder="15">
                </label>
                <label><i class="fas fa-handshake"></i> Hello Time (seconds)
                  <input id="br-hello-time" type="number" min="1" max="10" placeholder="2">
                </label>
              </details>
            </div>
            <button id="btn-create-bridge" class="btn btn-brand">
              <i class="fas fa-plus"></i> Create Bridge
            </button>
            <pre id="br-out" class="out"></pre>
          </div>

          <!-- Bond -->
          <div class="card">
            <h3><i class="fas fa-link"></i> Create Bond</h3>
            <label><i class="fas fa-tag"></i> Bond Name
              <input id="bond-name" type="text" required pattern="[a-zA-Z0-9_.-]+" placeholder="bond0">
            </label>
            <label><i class="fas fa-cog"></i> Bonding Mode
              <select id="bond-mode" required>
                <option value="active-backup"><i class="fas fa-sync-alt"></i> Active-Backup (Failover)</option>
                <option value="balance-rr"><i class="fas fa-balance-scale"></i> Balance Round-Robin</option>
                <option value="balance-xor"><i class="fas fa-dice"></i> Balance XOR</option>
                <option value="broadcast"><i class="fas fa-broadcast-tower"></i> Broadcast</option>
                <option value="802.3ad" selected><i class="fas fa-link"></i> 802.3ad (LACP)</option>
                <option value="balance-tlb"><i class="fas fa-bolt"></i> Balance TLB</option>
                <option value="balance-alb"><i class="fas fa-bolt"></i> Balance ALB</option>
              </select>
            </label>
            <label><i class="fas fa-network-wired"></i> Slave Interfaces (select two or more)
              <input id="bond-slaves-filter" type="text" placeholder="Filter interfaces..." style="margin-bottom: 0.5rem;">
              <select id="bond-slaves" multiple required style="height:100px;"></select>
            </label>
            <div class="advanced-options">
              <details>
                <summary><i class="fas fa-cog"></i> Advanced Options</summary>
                <label><i class="fas fa-clock"></i> MII Monitoring Interval (ms)
                  <input id="bond-miimon" type="number" min="0" placeholder="100">
                </label>
                <label><i class="fas fa-crown"></i> Primary Interface (for active-backup)
                  <select id="bond-primary"></select>
                </label>
                <label><i class="fas fa-chart-bar"></i> Link Monitoring
                  <select id="bond-link-mon">
                    <option value="miimon"><i class="fas fa-wifi"></i> MII Monitor</option>
                    <option value="arpmon"><i class="fas fa-globe"></i> ARP Monitor</option>
                  </select>
                </label>
              </details>
            </div>
            <button id="btn-create-bond" class="btn btn-brand">
              <i class="fas fa-plus"></i> Create Bond
            </button>
            <pre id="bond-out" class="out"></pre>
          </div>
        </div>
      </section>

      <!-- Routes -->
      <section id="panel-routes" class="tab-pane">
        <div class="toolbar">
          <div class="left">
            <button id="btn-refresh-routes" class="btn btn-outline-brand">
              <i class="fas fa-sync-alt"></i> Refresh Routes
            </button>
            <button id="btn-preserve-all-routes" class="btn btn-outline-success">
              <i class="fas fa-shield-alt"></i> Preserve All Routes
            </button>
          </div>
          <div class="right">
            <button id="btn-add-custom-route" class="btn btn-brand">
              <i class="fas fa-plus"></i> Add Route
            </button>
          </div>
        </div>

        <div class="grid">
          <!-- Current Routes Display -->
          <div class="card" style="grid-column: 1 / -1;">
            <h3><i class="fas fa-table"></i> Current System Routes</h3>
            <div id="routes-status" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: none;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-info-circle" style="color: #0056b3;"></i>
                <strong>Route Status Legend:</strong>
              </div>
              <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                <span style="color: #28a745;">✅ In Netplan</span> - Route is preserved in configuration<br>
                <span style="color: #ffc107;">⚠️ System Only</span> - Route may be lost during netplan apply
              </div>
            </div>
            <div id="routes-table-container">
              <p style="color: #6c757d; font-style: italic; text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin"></i> Loading routes...
              </p>
            </div>
          </div>

          <!-- Add Custom Route Form -->
          <div class="card" id="add-route-card" style="display: none;">
            <h3><i class="fas fa-plus"></i> Add Custom Route</h3>
            <label><i class="fas fa-bullseye"></i> Destination Network (CIDR)
              <input id="route-destination" placeholder="192.168.1.0/24 or 0.0.0.0/0" required>
              <small>Examples: 192.168.1.0/24, 10.0.0.0/8, 0.0.0.0/0 (default)</small>
            </label>
            <label><i class="fas fa-door-open"></i> Gateway (Optional)
              <input id="route-gateway" placeholder="192.168.1.1">
              <small>Leave empty for direct routes</small>
            </label>
            <label><i class="fas fa-network-wired"></i> Interface
              <select id="route-interface" required>
                <option value="">Select interface...</option>
              </select>
            </label>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
              <button id="btn-save-custom-route" class="btn btn-brand">
                <i class="fas fa-save"></i> Add Route
              </button>
              <button id="btn-cancel-custom-route" class="btn btn-outline-muted">
                <i class="fas fa-times"></i> Cancel
              </button>
            </div>
            <pre id="add-route-out" class="out"></pre>
          </div>

          <!-- Route Management Actions -->
          <div class="card">
            <h3><i class="fas fa-cogs"></i> Route Management</h3>
            <p style="margin-bottom: 1rem; color: #6c757d;">
              Manage system routes to prevent connectivity loss during network changes.
            </p>
            
            <div style="margin: 1rem 0;">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">
                <i class="fas fa-shield-alt" style="color: #28a745;"></i> Route Preservation
              </h4>
              <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6c757d;">
                Automatically add all current system routes to netplan configuration to prevent route loss.
              </p>
              <button id="btn-preserve-routes-detailed" class="btn btn-outline-success">
                <i class="fas fa-shield-alt"></i> Preserve All Current Routes
              </button>
            </div>

            <div style="margin: 1rem 0;">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">
                <i class="fas fa-download" style="color: #0056b3;"></i> Export Routes
              </h4>
              <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6c757d;">
                Export current route configuration for backup or migration.
              </p>
              <button id="btn-export-routes" class="btn btn-outline-info">
                <i class="fas fa-download"></i> Export Route Config
              </button>
            </div>

            <pre id="route-actions-out" class="out"></pre>
          </div>
        </div>
      </section>

      <!-- Diagnostics -->
      <section id="panel-diagnostics" class="tab-pane">
        <div class="card">
          <h3><i class="fas fa-stethoscope"></i> Network Diagnostics</h3>
          <div style="display: flex; gap: 1rem; align-items: end; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <label style="flex: 1; min-width: 200px;"><i class="fas fa-crosshairs"></i> Target Host/IP
              <input id="diag-host" placeholder="8.8.8.8" value="8.8.8.8">
            </label>
            <button id="btn-ping" class="btn btn-brand">
              <i class="fas fa-wifi"></i> Ping
            </button>
            <button id="btn-traceroute" class="btn btn-outline-brand">
              <i class="fas fa-route"></i> Traceroute
            </button>
          </div>
        </div>
        
        <div class="grid">
          <div class="card">
            <h3><i class="fas fa-wifi"></i> Ping Results</h3>
            <pre id="ping-out" class="out" style="min-height: 200px;">Click "Ping" to test connectivity...</pre>
          </div>
          <div class="card">
            <h3><i class="fas fa-route"></i> Routing Table</h3>
            <pre id="routes-out" class="out" style="min-height: 200px;">Loading routes...</pre>
          </div>
          <div class="card">
            <h3><i class="fas fa-server"></i> DNS Configuration</h3>
            <pre id="dns-out" class="out" style="min-height: 200px;">Loading DNS config...</pre>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer-actions">
      <span id="status">Ready</span>
      <span class="status-detail">XAVS Networking Management Interface</span>
    </footer>
  </div>
  </div>
  <!-- Load JavaScript modules -->
  <!-- Core XAVS modules as regular scripts (converted from ES6 modules) -->
  <script src="js/simple-yaml.js"></script>
  <script src="js/ui-utils.js"></script>
  <script src="js/validators.js"></script>
  <script src="js/run.js"></script>
  <script src="js/yaml-parser.js"></script>
  <script src="js/modal-renderer.js"></script>
  <script src="js/discover.js"></script>
  <script src="js/writer.js"></script>
  <script src="js/apply.js"></script>
  <script src="js/guardrails.js"></script>
  <script src="js/config.js"></script>
  
  <!-- Main application entry point -->
  <script src="main.js"></script>
  </div> <!-- .app -->
</body>
</html>
