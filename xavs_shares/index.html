<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XAVS Shares</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Cockpit API + Brand CSS -->
  <script src="../base1/cockpit.js"></script>
  <!-- FontAwesome CSS -->
  <link rel="stylesheet" href="fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="shares.css" />
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <header class="topbar">
      <h1 class="app-title"><i class="fa fa-share-nodes"></i> XAVS Shares</h1>
      <div class="help" data-tip="This module helps manage network shares:
• Create and manage NFS exports and mounts
• Set up and configure iSCSI targets and initiators
• Monitor active share connections and sessions
• Quick setup for common sharing scenarios">?</div>
    </header>

    <!-- Global error banner -->
    <div id="global-error" class="alert alert-warning d-none"></div>

    <!-- Tabs -->
    <ul class="nav-tabs" id="tabs">
      <li><a href="#" class="nav-link active" data-tab="tab-overview"><i class="fa fa-tachometer-alt"></i> Overview</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-nfs"><i class="fa fa-folder-open"></i> NFS</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-iscsi"><i class="fa fa-hdd"></i> iSCSI</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-logs"><i class="fa fa-terminal"></i> Logs</a></li>
    </ul>

    <main class="tab-content">
      <!-- TAB 1: OVERVIEW -->
      <section id="tab-overview" class="tab-pane show active">
        <div class="overview-grid">
          <!-- NFS Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-folder-open status-icon"></i>
              <h3>NFS Service</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="nfs-status-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Service Status:</div>
                  <div class="status-value" id="nfs-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Active Exports:</div>
                <div class="status-value" id="nfs-exports-count">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Active Mounts:</div>
                <div class="status-value" id="nfs-mounts-count">Loading...</div>
              </div>
            </div>
          </div>

          <!-- iSCSI Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-hdd status-icon"></i>
              <h3>iSCSI Service</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="iscsi-status-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Service Status:</div>
                  <div class="status-value" id="iscsi-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Active Targets:</div>
                <div class="status-value" id="iscsi-targets-count">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Active Sessions:</div>
                <div class="status-value" id="iscsi-sessions-count">Loading...</div>
              </div>
            </div>
          </div>

          <!-- System Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-server status-icon"></i>
              <h3>System Status</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="system-status-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Dependencies:</div>
                  <div class="status-value" id="system-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">NFS Tools:</div>
                <div class="status-value" id="nfs-tools-status">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">iSCSI Tools:</div>
                <div class="status-value" id="iscsi-tools-status">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-actions">
          <button class="btn btn-brand" id="refresh-overview-btn">
            <i class="fa fa-sync-alt"></i> Refresh Overview
          </button>
        </div>

        <!-- Active Connections Summary -->
        <div class="connections-section">
          <h3><i class="fa fa-network-wired"></i> Active Connections</h3>
          <div class="connections-grid">
            <div class="connection-card">
              <div class="connection-header">
                <h4><i class="fa fa-folder-open"></i> NFS Mounts</h4>
                <button id="btn-refresh-nfs-mounts" class="btn btn-outline-secondary btn-sm">
                  <i class="fa fa-refresh"></i> Refresh
                </button>
              </div>
              <div class="connection-body">
                <ul id="nfs-mounts-list" class="connection-list">
                  <li class="loading">Loading...</li>
                </ul>
              </div>
            </div>

            <div class="connection-card">
              <div class="connection-header">
                <h4><i class="fa fa-link"></i> iSCSI Sessions</h4>
                <button id="btn-refresh-iscsi-sessions" class="btn btn-outline-secondary btn-sm">
                  <i class="fa fa-refresh"></i> Refresh
                </button>
              </div>
              <div class="connection-body">
                <ul id="iscsi-sessions-list" class="connection-list">
                  <li class="loading">Loading...</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 2: NFS -->
      <section id="tab-nfs" class="tab-pane">
        <div class="nfs-grid">
          <!-- NFS Exports Management -->
          <div class="management-card">
            <div class="management-card-header">
              <h3><i class="fa fa-list"></i> NFS Exports</h3>
              <div class="card-actions">
                <button id="btn-exports-reload" class="btn btn-outline-secondary btn-sm">
                  <i class="fa fa-refresh"></i> Reload
                </button>
              </div>
            </div>
            <div class="management-card-body">
              <div class="exports-container">
                <ul id="nfs-exports-list" class="exports-list">
                  <li class="loading">Loading...</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- NFS Operations -->
          <div class="management-card">
            <div class="management-card-header">
              <h3><i class="fa fa-cogs"></i> NFS Operations</h3>
            </div>
            <div class="management-card-body">
              <!-- Toggle for Create/Mount -->
              <div class="toggle-pill" role="tablist" aria-label="NFS operation mode">
                <button id="toggle-nfs-create" class="toggle-seg active" type="button" aria-selected="true">Create Export</button>
                <button id="toggle-nfs-mount" class="toggle-seg" type="button" aria-selected="false">Mount NFS</button>
              </div>

              <!-- Create NFS Share -->
              <div id="nfs-create-block">
                <form id="nfs-create-form" class="form">
                  <div class="form-group">
                    <label class="form-label" for="nfs-name">Share Name</label>
                    <input id="nfs-name" class="form-control" placeholder="e.g., projectA" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="nfs-base">Base Path</label>
                    <input id="nfs-base" class="form-control" value="/srv/nfs" required>
                    <div class="hint">Final path: <code>BASE/NAME</code> (created if missing)</div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label" for="nfs-perm">Permission</label>
                      <select id="nfs-perm" class="form-control">
                        <option value="rw">Read/Write</option>
                        <option value="ro">Read Only</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="nfs-scope">Access Scope</label>
                      <input id="nfs-scope" class="form-control" value="*" placeholder="CIDR/host or * for all">
                    </div>
                  </div>

                  <div class="form-check">
                    <input id="nfs-no-root-squash" type="checkbox" class="form-check-input">
                    <label for="nfs-no-root-squash" class="form-check-label">Allow root access (no_root_squash)</label>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                      <i class="fa fa-save"></i> Create Export
                    </button>
                    <button type="button" id="btn-nfs-clear" class="btn btn-outline-secondary">
                      <i class="fa fa-eraser"></i> Clear
                    </button>
                  </div>
                </form>
                <div id="nfs-create-msg" class="message"></div>
              </div>

              <!-- Mount NFS Share -->
              <div id="nfs-mount-block" class="nfs-mount-hidden">
                <form id="nfs-mount-form" class="form">
                  <div class="form-group">
                    <label class="form-label" for="nm-server">NFS Server (IP or hostname)</label>
                    <input id="nm-server" class="form-control" placeholder="e.g., 192.168.1.100" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="nm-export">Export Path</label>
                    <input id="nm-export" class="form-control" placeholder="e.g., /srv/nfs/projectA" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="nm-mountpoint">Local Mount Point</label>
                    <input id="nm-mountpoint" class="form-control" value="/mnt/nfs" required>
                    <div class="hint">Directory will be created if it doesn't exist</div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label" for="nm-version">NFS Version</label>
                      <select id="nm-version" class="form-control">
                        <option value="4">NFSv4 (recommended)</option>
                        <option value="3">NFSv3</option>
                        <option value="2">NFSv2</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="nm-options">Mount Options</label>
                      <input id="nm-options" class="form-control" value="defaults" placeholder="e.g., rw,sync,hard">
                    </div>
                  </div>

                  <div class="form-check">
                    <input id="nm-persistent" type="checkbox" class="form-check-input">
                    <label for="nm-persistent" class="form-check-label">Make mount persistent (add to /etc/fstab)</label>
                    <div class="hint">Mount will survive reboots</div>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                      <i class="fa fa-link"></i> Mount NFS Share
                    </button>
                    <button type="button" id="btn-nfs-mount-clear" class="btn btn-outline-secondary">
                      <i class="fa fa-eraser"></i> Clear
                    </button>
                  </div>
                  <div id="nfs-mount-msg" class="message"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 3: iSCSI -->
      <section id="tab-iscsi" class="tab-pane">
        <div class="iscsi-grid">
          <!-- iSCSI Targets Management -->
          <div class="management-card">
            <div class="management-card-header">
              <h3><i class="fa fa-list"></i> iSCSI Targets</h3>
              <div class="card-actions">
                <button id="btn-cleanup-backstores" class="btn btn-danger btn-sm" title="⚠️ DANGER: This will remove ALL backstores from the system">
                  <i class="fa fa-exclamation-triangle"></i> Cleanup All
                </button>
                <button id="btn-targets-refresh" class="btn btn-outline-secondary btn-sm">
                  <i class="fa fa-refresh"></i> Refresh
                </button>
              </div>
            </div>
            <div class="management-card-body">
              <div class="targets-container">
                <ul id="iscsi-targets-list" class="targets-list">
                  <li class="loading">Loading...</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- iSCSI Operations -->
          <div class="management-card">
            <div class="management-card-header">
              <h3><i class="fa fa-cogs"></i> iSCSI Operations</h3>
            </div>
            <div class="management-card-body">
              <!-- Toggle for Create/Mount -->
              <div class="toggle-pill" role="tablist" aria-label="iSCSI operation mode">
                <button id="toggle-iscsi-create" class="toggle-seg active" type="button" aria-selected="true">Create Target</button>
                <button id="toggle-iscsi-mount" class="toggle-seg" type="button" aria-selected="false">Mount Target</button>
              </div>

              <!-- Create iSCSI Target -->
              <div id="iscsi-create-block">
                <form id="iscsi-create-form" class="form">
                  <div class="form-group">
                    <label class="form-label" for="iscsi-name">Target Name</label>
                    <input id="iscsi-name" class="form-control" placeholder="e.g., projectA-lun0" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="iscsi-backing-store">Backing Store</label>
                    <select id="iscsi-backing-store" class="form-control" required>
                      <option value="">Select backing store type...</option>
                      <option value="file">File-based (safer)</option>
                      <optgroup label="Available Disks (WARNING: Will be completely wiped!)">
                        <!-- Disks will be populated by JavaScript -->
                      </optgroup>
                    </select>
                    <div class="hint">File-based creates a virtual disk file. Disk-based uses entire physical disk.</div>
                  </div>

                  <!-- File-based options -->
                  <div id="iscsi-file-options" class="hidden">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label" for="iscsi-size">Size (GB)</label>
                        <input id="iscsi-size" type="number" min="1" max="1000" class="form-control" value="10" required>
                      </div>
                      <div class="form-group">
                        <label class="form-label" for="iscsi-path">Storage Path</label>
                        <input id="iscsi-path" class="form-control" value="/var/lib/iscsi-disks" placeholder="Directory for backing files">
                      </div>
                    </div>
                  </div>

                  <!-- Disk-based warning -->
                  <div id="iscsi-disk-warning" class="form-group hidden">
                    <div class="alert alert-danger">
                      <i class="fa fa-exclamation-triangle"></i>
                      <strong>DANGER:</strong> Selected disk will be completely erased and used as iSCSI backing store. All existing data will be lost!
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="iscsi-portal">Portal Address</label>
                    <input id="iscsi-portal" class="form-control" value="0.0.0.0" placeholder="0.0.0.0 (default - listen on all interfaces)" pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" title="Please enter a valid IP address (e.g., 192.168.1.100)">
                    <div class="hint">IP address where the iSCSI target will listen for connections. Use 0.0.0.0 to listen on all network interfaces.</div>
                  </div>

                  <div class="form-check">
                    <input id="iscsi-open-acl" type="checkbox" class="form-check-input" checked>
                    <label for="iscsi-open-acl" class="form-check-label">Allow any initiator (generate_node_acls)</label>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                      <i class="fa fa-save"></i> Create Target + LUN
                    </button>
                    <button type="button" id="btn-iscsi-clear" class="btn btn-outline-secondary">
                      <i class="fa fa-eraser"></i> Clear
                    </button>
                  </div>
                  <div id="iscsi-create-msg" class="message"></div>
                </form>
              </div>

              <!-- Mount iSCSI Target -->
              <div id="iscsi-mount-block" class="iscsi-mount-hidden">
                <!-- Stage 1: Discovery -->
                <div id="iscsi-discovery-stage">
                  <h4><i class="fa fa-search"></i> Discover iSCSI Targets</h4>
                  <form id="iscsi-discovery-form" class="form">
                    <div class="form-group">
                      <label class="form-label" for="im-portal">Portal (IP:port)</label>
                      <input id="im-portal" class="form-control" placeholder="192.168.1.100:3260" required pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?::\d{1,5})?$" title="Please enter a valid IP address with optional port (e.g., 192.168.1.100:3260)">
                      <div class="hint">Enter the IP address and port of the iSCSI target server</div>
                    </div>

                    <div class="form-actions">
                      <button type="submit" class="btn btn-brand">
                        <i class="fa fa-search"></i> Discover Targets
                      </button>
                    </div>
                    <div id="iscsi-discovery-msg" class="message"></div>
                  </form>

                  <!-- Discovery Results -->
                  <div id="iscsi-discovery-results" class="hidden">
                    <h5><i class="fa fa-list"></i> Available Targets</h5>
                    <div class="table-container">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Target IQN</th>
                            <th>Portal</th>
                            <th>Status</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody id="iscsi-targets-table">
                          <!-- Discovery results will be populated here -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Stage 2: Login and Mount -->
                <div id="iscsi-mount-stage" class="hidden">
                  <h4><i class="fa fa-sign-in-alt"></i> Login and Mount Target</h4>
                  <form id="iscsi-mount-form" class="form">
                    <div class="form-group">
                      <label class="form-label">Selected Target</label>
                      <div id="selected-target-info" class="alert alert-info">
                        <!-- Selected target info will be shown here -->
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label" for="im-fstype">Filesystem</label>
                        <select id="im-fstype" class="form-control">
                          <option value="ext4" selected>ext4</option>
                          <option value="xfs">xfs</option>
                          <option value="btrfs">btrfs</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="im-mountpoint">Mountpoint</label>
                        <input id="im-mountpoint" class="form-control" value="/mnt/iscsi" required>
                      </div>
                    </div>

                    <div class="alert alert-info">
                      <i class="fa fa-info-circle"></i>
                      <strong>Auto-Format:</strong> The iSCSI disk will be automatically formatted with the selected filesystem if it's unformatted.
                    </div>

                    <div class="form-actions">
                      <button type="submit" class="btn btn-success">
                        <i class="fa fa-hdd"></i> Login and Mount
                      </button>
                      <button type="button" id="btn-back-to-discovery" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left"></i> Back to Discovery
                      </button>
                      <button type="button" id="btn-im-logout" class="btn btn-outline-danger">
                        <i class="fa fa-sign-out-alt"></i> Logout All
                      </button>
                    </div>
                    <div id="iscsi-mount-msg" class="message"></div>
                  </form>
                </div>
              </div>
                  <div id="iscsi-mount-msg" class="message"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- TAB 4: LOGS -->
      <section id="tab-logs" class="tab-pane">
        <div class="logs-card">
          <div class="logs-header">
            <h3><i class="fa fa-terminal"></i> System Activity Log</h3>
            <div class="logs-actions">
              <button class="btn btn-outline-secondary" id="btn-refresh-logs">
                <i class="fa fa-refresh"></i> Refresh
              </button>
              <button class="btn btn-outline-secondary" id="btn-clear-logs">
                <i class="fa fa-trash"></i> Clear
              </button>
            </div>
          </div>
          <div class="logs-body">
            <pre class="log-terminal" id="log-display"></pre>
          </div>
        </div>
      </section>
    </main>

    <!-- Status Bar -->
    <div class="status-bar">
      <span id="status-text">Ready</span>
      <span class="status-actions">
        <a href="#" class="status-link" data-tab="tab-logs">View Logs</a>
      </span>
    </div>

    <!-- ===== Inline debug console (hidden by default) ===== -->
    <div id="debug-panel" class="debug-panel hidden">
      <div class="debug-header">
        <strong><i class="fa fa-bug"></i> Debug Console</strong>
        <div class="debug-actions">
          <button id="btn-debug-copy" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-clipboard"></i> Copy
          </button>
          <button id="btn-debug-clear" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-trash"></i> Clear
          </button>
          <button id="btn-debug-close" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times"></i> Close
          </button>
        </div>
      </div>
      <pre id="debug-log" class="debug-body"></pre>
    </div>
  </div>

  <script defer src="shares.js"></script>
</body>
</html>
