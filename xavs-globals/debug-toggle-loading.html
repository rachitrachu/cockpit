<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toggle Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .debug-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .config-sample {
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .switch-test {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #dee2e6;
            margin: 5px 0;
            border-radius: 4px;
        }
        .switch-test.updated {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .switch-test.failed {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>üîç Toggle Loading Debug Test</h1>
    
    <div class="alert alert-info">
        <strong>üéØ Debug Objective:</strong>
        Diagnose why toggles are not being properly set when loading YAML configurations.
        This test will show exactly what happens during the loading process.
    </div>

    <div class="test-section">
        <h3>üìã Test Configuration</h3>
        <div class="config-sample">basics:
  kolla_enable_tls_external: yes
  kolla_enable_tls_internal: yes
  kolla_external_fqdn: external.example.com
  kolla_internal_fqdn: internal.example.com

storage:
  enable_cinder: yes
  cinder_volume_group: cinder-volumes

network:
  enable_neutron_provider_networks: yes
  enable_neutron_dvr: no</div>
    </div>

    <div class="test-section">
        <h3>üß™ Debug Tests</h3>
        <button class="btn btn-primary" onclick="testFormExists()">1. Check Form Elements Exist</button>
        <button class="btn btn-primary" onclick="testSwitchCreation()">2. Create Test Switches</button>
        <button class="btn btn-primary" onclick="testEventHandlers()">3. Test Event Handlers</button>
        <button class="btn btn-primary" onclick="testConfigLoad()">4. Test Config Loading</button>
        <button class="btn btn-primary" onclick="clearDebug()">Clear Debug</button>
    </div>

    <div class="test-section">
        <h3>üîÑ Switch States</h3>
        <div id="switch-states"></div>
    </div>

    <div class="test-section">
        <h3>üìä Debug Output</h3>
        <div class="debug-output" id="debug"></div>
    </div>

    <div id="status_panel" class="alert" style="display: none;"></div>

    <script>
        const debugOutput = document.getElementById('debug');
        
        function addDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ff00',
                'warn': '#ffff00',
                'error': '#ff0000',
                'success': '#00ff00'
            };
            
            debugOutput.innerHTML += `<span style="color: ${colors[type] || '#00ff00'}">[${timestamp}] ${message}</span>\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        function clearDebug() {
            debugOutput.innerHTML = '';
            addDebug('Debug output cleared', 'info');
        }

        function showStatus(message, type) {
            const statusPanel = document.getElementById('status_panel');
            if (statusPanel) {
                statusPanel.className = `alert alert-${type}`;
                statusPanel.textContent = message;
                statusPanel.style.display = 'block';
                
                setTimeout(() => {
                    statusPanel.style.display = 'none';
                }, 3000);
            }
        }

        function testFormExists() {
            addDebug('üîç Testing if form container exists...', 'info');
            
            // Mock form container check
            const hasContainer = true; // Simulate container existence
            addDebug(`Form container exists: ${hasContainer}`, hasContainer ? 'success' : 'error');
            
            // Check for specific elements that should exist
            const expectedElements = [
                'basics_kolla_enable_tls_external',
                'basics_kolla_enable_tls_internal', 
                'storage_enable_cinder',
                'network_enable_neutron_provider_networks',
                'network_enable_neutron_dvr'
            ];
            
            expectedElements.forEach(id => {
                const exists = document.getElementById(id) !== null;
                addDebug(`Element ${id}: ${exists ? '‚úÖ EXISTS' : '‚ùå MISSING'}`, exists ? 'success' : 'error');
            });
            
            showStatus('Form existence check completed', 'info');
        }

        function testSwitchCreation() {
            addDebug('üîß Creating test switch elements...', 'info');
            
            const switchStatesDiv = document.getElementById('switch-states');
            switchStatesDiv.innerHTML = '';
            
            const switches = [
                { id: 'basics_kolla_enable_tls_external', label: 'TLS External', configValue: 'yes' },
                { id: 'basics_kolla_enable_tls_internal', label: 'TLS Internal', configValue: 'yes' },
                { id: 'storage_enable_cinder', label: 'Enable Cinder', configValue: 'yes' },
                { id: 'network_enable_neutron_provider_networks', label: 'Provider Networks', configValue: 'yes' },
                { id: 'network_enable_neutron_dvr', label: 'DVR', configValue: 'no' }
            ];
            
            switches.forEach(switchData => {
                // Create switch HTML
                const switchHTML = `
                    <div class="switch-test" id="${switchData.id}_container">
                        <input class="switch-input" type="checkbox" id="${switchData.id}" name="${switchData.id}" />
                        <label for="${switchData.id}">${switchData.label}</label>
                        <span id="${switchData.id}_status">Status: Not set</span>
                    </div>
                `;
                switchStatesDiv.innerHTML += switchHTML;
                
                addDebug(`Created switch: ${switchData.id}`, 'success');
                
                // Add event listener
                const switchEl = document.getElementById(switchData.id);
                if (switchEl) {
                    switchEl.addEventListener('change', function() {
                        const statusEl = document.getElementById(`${switchData.id}_status`);
                        const container = document.getElementById(`${switchData.id}_container`);
                        
                        statusEl.textContent = `Status: ${this.checked ? 'ON' : 'OFF'} (value: ${this.value || 'undefined'})`;
                        container.className = 'switch-test updated';
                        
                        addDebug(`Switch ${switchData.id} changed: checked=${this.checked}, value=${this.value}`, 'info');
                    });
                    
                    addDebug(`Event listener added to: ${switchData.id}`, 'success');
                }
            });
            
            showStatus('Test switches created successfully', 'success');
        }

        function testEventHandlers() {
            addDebug('üîÑ Testing event handlers...', 'info');
            
            const switches = document.querySelectorAll('.switch-input');
            addDebug(`Found ${switches.length} switch elements`, 'info');
            
            switches.forEach(switchEl => {
                // Test direct property setting
                addDebug(`Testing ${switchEl.id}:`, 'info');
                
                // Set checked property
                switchEl.checked = true;
                switchEl.value = 'yes';
                addDebug(`  Set checked=true, value='yes'`, 'info');
                addDebug(`  Actual: checked=${switchEl.checked}, value=${switchEl.value}`, 'info');
                
                // Trigger change event
                addDebug(`  Triggering change event...`, 'info');
                switchEl.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Wait a bit then check status
                setTimeout(() => {
                    const statusEl = document.getElementById(`${switchEl.id}_status`);
                    addDebug(`  Status after event: ${statusEl ? statusEl.textContent : 'Status element not found'}`, 'info');
                }, 100);
            });
            
            showStatus('Event handler test completed', 'info');
        }

        function testConfigLoad() {
            addDebug('üìã Testing configuration loading simulation...', 'info');
            
            const testConfig = {
                basics: {
                    kolla_enable_tls_external: 'yes',
                    kolla_enable_tls_internal: 'yes',
                },
                storage: {
                    enable_cinder: 'yes'
                },
                network: {
                    enable_neutron_provider_networks: 'yes',
                    enable_neutron_dvr: 'no'
                }
            };
            
            addDebug('Config to load:', 'info');
            addDebug(JSON.stringify(testConfig, null, 2), 'info');
            
            // Simulate populateFormFromConfig
            for (const [section, fields] of Object.entries(testConfig)) {
                for (const [key, value] of Object.entries(fields)) {
                    const id = `${section}_${key}`;
                    const el = document.getElementById(id);
                    
                    if (!el) {
                        addDebug(`‚ùå Element not found: ${id}`, 'error');
                        continue;
                    }
                    
                    if (el.classList.contains('switch-input')) {
                        const isChecked = String(value).toLowerCase() === 'yes';
                        addDebug(`Setting switch ${id}: value='${value}' -> checked=${isChecked}`, 'info');
                        
                        // Set the values
                        el.checked = isChecked;
                        el.value = isChecked ? 'yes' : 'no';
                        
                        // Trigger change event
                        addDebug(`Triggering change event for ${id}`, 'info');
                        el.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // Check if it worked
                        setTimeout(() => {
                            const container = document.getElementById(`${id}_container`);
                            if (el.checked === isChecked) {
                                addDebug(`‚úÖ Switch ${id} successfully set to ${isChecked}`, 'success');
                                if (container) container.className = 'switch-test updated';
                            } else {
                                addDebug(`‚ùå Switch ${id} failed to set. Expected: ${isChecked}, Actual: ${el.checked}`, 'error');
                                if (container) container.className = 'switch-test failed';
                            }
                        }, 150);
                    } else {
                        addDebug(`Skipping non-switch element: ${id}`, 'warn');
                    }
                }
            }
            
            showStatus('Configuration loading test completed', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addDebug('üöÄ Toggle Debug Test Page Loaded', 'success');
            showStatus('Debug test ready. Run tests to diagnose toggle loading issues.', 'info');
        });
    </script>
</body>
</html>
