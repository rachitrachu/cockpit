<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XAVS Images</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Brand CSS + Local Font Awesome -->
  <link rel="stylesheet" href="xavs-images.css" />
  <link rel="stylesheet" href="fontawesome/css/all.css" />
  <!-- Cockpit JavaScript API -->
  <script src="../base1/cockpit.js"></script>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <header class="topbar">
      <h1 class="app-title"><i class="fa fa-box"></i> XAVS Images</h1>
      <div class="help" data-tip="This module helps manage image deployment:
‚Ä¢ Extract a .tar.gz of Docker images by path
‚Ä¢ Pull from Xloud registry (/etc/xavs/images.list)
‚Ä¢ Run local registry named docker-registry on port 4000
‚Ä¢ Push images to docker-registry:4000 and view catalog">?</div>
    </header>

    <!-- Tabs -->
    <ul class="nav-tabs" id="tabs">
      <li><a href="#" class="nav-link active" data-tab="tab-overview"><i class="fa fa-tachometer-alt"></i> Overview</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-extract"><i class="fa fa-file-archive"></i> Extract / Pull</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-registry"><i class="fa fa-server"></i> Local Registry</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-push"><i class="fa fa-upload"></i> Push Images</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-catalog"><i class="fa fa-list"></i> Catalog</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-config"><i class="fa fa-cog"></i> Configuration</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-logs"><i class="fa fa-terminal"></i> Logs</a></li>
    </ul>

    <main class="tab-content">
      <!-- TAB 1: OVERVIEW -->
      <section id="tab-overview" class="tab-pane show active">
        <div class="overview-grid">
          <!-- Docker Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-docker status-icon"></i>
              <h3>Docker Engine</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="docker-status-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Service Status:</div>
                  <div class="status-value" id="docker-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Version:</div>
                <div class="status-value" id="docker-version">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Local Images:</div>
                <div class="status-value" id="docker-images-count">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Registry Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-server status-icon"></i>
              <h3>Local Registry</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="overview-registry-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Status:</div>
                  <div class="status-value" id="overview-registry-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Endpoint:</div>
                <div class="status-value">docker-registry:4000</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Registry Images:</div>
                <div class="status-value" id="registry-images-count">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Configuration Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-cog status-icon"></i>
              <h3>Configuration</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="overview-config-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Docker Config:</div>
                  <div class="status-value" id="overview-config-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Images List:</div>
                <div class="status-value" id="images-list-count">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Insecure Registry:</div>
                <div class="status-value" id="insecure-registry-status">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-actions">
          <button class="btn btn-brand" id="refresh-overview-btn">
            <i class="fa fa-sync-alt"></i> Refresh Overview
          </button>
          <button class="btn btn-outline-brand" id="quick-setup-btn">
            <i class="fa fa-magic"></i> Quick Setup
          </button>
        </div>
      </section>

      <!-- TAB 2: EXTRACT / PULL -->
      <section id="tab-extract" class="tab-pane">
        <!-- Toggle pill -->
        <div class="toggle-pill" role="tablist" aria-label="Mode toggle">
          <button id="toggle-extract" class="toggle-seg active" type="button" aria-selected="true">Extract</button>
          <button id="toggle-pull" class="toggle-seg" type="button" aria-selected="false">Pull</button>
        </div>

        <!-- Extract block -->
        <div id="extract-block">
          <label class="form-label" for="file-path">Path to <code>.tar.gz</code> archive on server</label>
          <input id="file-path" class="form-control" placeholder="/root/xdeploy/images-archive.tar.gz" />
          <div class="hint">Archive will be extracted to <code>/root/xdeploy/xdeploy-images/</code>, then all <code>.tar</code> images are <strong>docker load</strong>‚Äôed and their tar files are removed.</div>
          <div class="actions">
            <button class="btn btn-brand" id="extract-btn">Extract & Load</button>
          </div>
        </div>

        <!-- Pull block -->
        <div id="pull-block" class="pull-block-hidden">
          <p class="hint">
            Reads image names from <code>/etc/xavs/images.list</code> and pulls from
            <code>quay.io/xavs.images/&lt;name&gt;:&lt;tag&gt;</code>.
          </p>
          
          <!-- Current Images List -->
          <div class="images-list-section">
            <h4>üì¶ Current Images List <span id="current-images-count">(Loading...)</span></h4>
            <div class="images-list-container">
              <ul id="current-images-list" class="images-list">
                <li>Loading images...</li>
              </ul>
            </div>
            <div class="images-list-actions">
              <button class="btn btn-outline-secondary" id="refresh-images-list-btn">üîÑ Refresh List</button>
              <button class="btn btn-outline-danger" id="clear-all-images-btn">üóëÔ∏è Clear All</button>
            </div>
          </div>
          
          <div class="actions">
            <button class="btn btn-outline-secondary" id="test-connectivity-btn">Test Connectivity</button>
            <button class="btn btn-outline-brand" id="pull-btn">Pull from Xloud</button>
          </div>
        </div>
      </section>

      <!-- TAB 3: LOCAL REGISTRY -->
      <section id="tab-registry" class="tab-pane">
        <div class="status-row">
          <div class="status-dot" id="registry-dot" aria-hidden="true"></div>
          <div>Status: <span id="registry-status">Checking‚Ä¶</span></div>
        </div>
        <div class="actions">
          <button class="btn btn-outline-muted" id="run-registry-btn">Run Registry</button>
          <button class="btn btn-outline-danger" id="stop-registry-btn">Stop Registry</button>
          <button class="btn btn-outline-muted" id="restart-docker-btn" disabled>Restart Docker</button>
          <button class="btn btn-outline-brand" id="check-status-btn">Re-check Status</button>
        </div>
        <div class="hint">
          Creates/updates <code>/etc/docker/daemon.json</code> with
          <code>"insecure-registries": ["docker-registry:4000"]</code>.
          After writing, restart Docker to apply.
        </div>
      </section>

      <!-- TAB 4: PUSH IMAGES -->
      <section id="tab-push" class="tab-pane">
        <p class="hint">
          Tags images from <code>quay.io/xavs.images</code> to
          <code>docker-registry:4000/xavs.images</code>, pushes, then removes the public-tagged local copies.
          List is read from <code>/etc/xavs/images.list</code>.
        </p>
        <div class="actions">
          <button class="btn btn-brand" id="push-btn" disabled>Push Images</button>
        </div>
      </section>

      <!-- TAB 5: CATALOG -->
      <section id="tab-catalog" class="tab-pane">
        <div class="actions">
          <button class="btn btn-outline-brand" id="refresh-catalog-btn">Refresh Catalog</button>
        </div>
        <ul id="catalog" class="catalog-list"></ul>
      </section>

      <!-- TAB 6: CONFIGURATION -->
      <section id="tab-config" class="tab-pane">
        <!-- Docker Configuration -->
        <div class="config-section">
          <h3><i class="fa fa-docker"></i> Docker Configuration</h3>
          <div class="status-row">
            <div class="status-dot" id="docker-config-dot" aria-hidden="true"></div>
            <div>Docker daemon.json: <span id="docker-config-status">Checking‚Ä¶</span></div>
          </div>
          <div class="actions">
            <button class="btn btn-brand" id="apply-docker-config-btn">Apply Docker Config</button>
            <button class="btn btn-outline-brand" id="check-docker-config-btn">Check Config</button>
          </div>
          <div class="hint">
            Configures Docker daemon with insecure registry support for docker-registry:4000
          </div>
          
          <details class="config-details">
            <summary>Current Docker Configuration</summary>
            <pre id="current-docker-config" class="config-display">No configuration loaded</pre>
          </details>
        </div>

        <!-- Images List Management -->
        <div class="config-section">
          <h3><i class="fa fa-list-ul"></i> Images List Management</h3>
          <p class="hint">
            Manage the hardcoded list of Docker images at <code>/etc/xavs/images.list</code>
          </p>
          <div class="actions">
            <button class="btn btn-outline-brand" id="view-images-list-btn">View Current List</button>
            <button class="btn btn-brand" id="update-images-list-btn">Update List</button>
          </div>
          
          <details class="config-details">
            <summary>Current Images List</summary>
            <pre id="images-list-content" class="config-display">Click "View Current List" to load</pre>
          </details>
          
          <details class="config-details">
            <summary>Edit Images List</summary>
            <textarea id="images-list-editor" class="config-editor" placeholder="Enter one image per line, e.g.&#10;kolla/ubuntu-source-keystone:2024.1&#10;kolla/ubuntu-source-glance-api:2024.1"></textarea>
            <div class="editor-hint">One image per line. Lines starting with # are comments.</div>
          </details>
        </div>
      </section>

      <!-- TAB 7: LOGS -->
      <section id="tab-logs" class="tab-pane">
        <div class="card">
          <strong>Execution Log</strong>
          <pre class="yaml-terminal" id="log"></pre>
          <div class="footer-actions">
            <button class="btn btn-outline-muted" id="btn-clear-log" type="button">Clear log</button>
          </div>
        </div>
      </section>
    </main>

    <!-- Status Bar -->
    <div class="status-bar">
      <span id="status-text">Ready</span>
      <span class="status-actions">
        <a href="#" class="status-link" data-tab="tab-logs">View Logs</a>
      </span>
    </div>
  </div>

  <script src="xavs-images.js"></script>
</body>
</html>
