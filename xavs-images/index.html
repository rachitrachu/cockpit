<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XAVS Images</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Brand CSS + Local Font Awesome -->
  <link rel="stylesheet" href="xavs-images.css" />
  <link rel="stylesheet" href="fontawesome/css/all.css" />
  <!-- Cockpit JavaScript API -->
  <script src="../base1/cockpit.js"></script>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <header class="topbar">
      <h1 class="app-title">
        <img src="logo-x.png" alt="X" class="logo-x">AVS Images
      </h1>
      <div class="help" data-tip="This module helps manage image deployment:
‚Ä¢ Extract a .tar.gz of Docker images by path
‚Ä¢ Pull from Xloud registry (/etc/xavs/images.list)
‚Ä¢ Run local registry named docker-registry on port 4000
‚Ä¢ Push images to docker-registry:4000 and view catalog">?</div>
    </header>

    <!-- Tabs -->
    <ul class="nav-tabs" id="tabs">
      <li><a href="#" class="nav-link active" data-tab="tab-overview"><i class="fa fa-tachometer-alt"></i> Overview</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-extract"><i class="fa fa-file-archive"></i> Extract / Pull</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-registry"><i class="fa fa-database"></i> Registry Management</a></li>
      <li><a href="#" class="nav-link" data-tab="tab-logs"><i class="fa fa-terminal"></i> Logs</a></li>
    </ul>

    <main class="tab-content">
      <!-- TAB 1: OVERVIEW -->
      <section id="tab-overview" class="tab-pane show active">
        <div class="overview-grid">
          <!-- Docker Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-cube status-icon"></i>
              <h3>Docker Engine</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="docker-status-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Service Status:</div>
                  <div class="status-value" id="docker-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Version:</div>
                <div class="status-value" id="docker-version">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Local Images:</div>
                <div class="status-value" id="docker-images-count">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Registry Status Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-server status-icon"></i>
              <h3>Local Registry</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="overview-registry-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Status:</div>
                  <div class="status-value" id="overview-registry-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Endpoint:</div>
                <div class="status-value">docker-registry:4000</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Registry Images:</div>
                <div class="status-value" id="registry-images-count">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Docker Registry Setup Card -->
          <div class="status-card">
            <div class="status-card-header">
              <i class="fa fa-server status-icon"></i>
              <h3>Registry Setup</h3>
            </div>
            <div class="status-card-body">
              <div class="status-row">
                <div class="status-dot" id="overview-config-dot" aria-hidden="true"></div>
                <div class="status-info">
                  <div class="status-label">Docker Config:</div>
                  <div class="status-value" id="overview-config-status">Checking...</div>
                </div>
              </div>
              <div class="status-detail">
                <div class="status-label">Images List:</div>
                <div class="status-value" id="images-list-count">Loading...</div>
              </div>
              <div class="status-detail">
                <div class="status-label">Insecure Registry:</div>
                <div class="status-value" id="insecure-registry-status">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-actions">
          <button class="btn btn-brand" id="refresh-overview-btn">
            <i class="fa fa-sync-alt"></i> Refresh Overview
          </button>
          <button class="btn btn-outline-brand" id="quick-setup-btn">
            <i class="fa fa-magic"></i> Quick Setup
          </button>
        </div>
      </section>

      <!-- TAB 2: EXTRACT / PULL -->
      <section id="tab-extract" class="tab-pane">
        <!-- Toggle pill -->
        <div class="toggle-pill" role="tablist" aria-label="Mode toggle">
          <button id="toggle-extract" class="toggle-seg active" type="button" aria-selected="true">Extract</button>
          <button id="toggle-pull" class="toggle-seg" type="button" aria-selected="false">Pull</button>
        </div>

        <!-- USB Devices Section -->
        <div id="usb-devices-section" class="usb-section">
          <h4><i class="fa fa-usb"></i> USB Storage Devices</h4>
          <div class="usb-devices-container">
            <div id="usb-devices-list" class="usb-devices-list">
              <div class="loading-state">Checking for USB devices...</div>
            </div>
            <div class="usb-controls">
              <button id="refresh-usb-devices" class="btn btn-sm btn-outline-secondary">
                <i class="fa fa-sync"></i> Refresh
              </button>
            </div>
          </div>
          <div id="no-usb-devices" class="alert alert-secondary" style="display: none;">
            <i class="fa fa-info-circle"></i> No USB storage devices detected. Insert a USB drive and click Refresh.
          </div>
        </div>

        <!-- Extract block -->
        <div id="extract-block">
          <label class="form-label" for="file-path">Path to <code>.tar.gz</code> archive on server</label>
          <div class="file-path-group">
            <input id="file-path" class="form-control" placeholder="/root/xdeploy/images-archive.tar.gz" />
            <button class="btn btn-outline-secondary" id="browse-server-btn" type="button" title="Browse server for .tar.gz archive">
              <i class="fa fa-folder-open"></i> Browse
            </button>
          </div>
          <div class="hint">Archive will be extracted to <code>/root/xdeploy/xdeploy-images/</code>, then all <code>.tar</code> images are <strong>docker load</strong>‚Äôed and their tar files are removed.</div>
          <div class="actions">
            <button class="btn btn-brand" id="extract-btn">Extract & Load</button>
          </div>
        </div>

        <!-- Pull block -->
        <div id="pull-block" class="pull-block-hidden">
          
          <!-- Current Images List -->
          <div class="images-list-section">
            <h4>üì¶ Current Images List <span id="current-images-count">(Loading...)</span></h4>
            <div class="hint">Images loaded from configuration file</div>
            <div class="images-list-container">
              <ul id="current-images-list" class="images-list">
                <li>Loading images...</li>
              </ul>
            </div>
          </div>
          
          <!-- Locally Pulled Images -->
          <div class="images-list-section">
            <h4>üê≥ Locally Pulled Images <span id="local-images-count">(Loading...)</span></h4>
            <div class="images-list-container">
              <ul id="local-images-list" class="images-list">
                <li>Loading Docker images...</li>
              </ul>
            </div>
            <div class="images-list-actions">
              <button class="btn btn-outline-secondary" id="refresh-local-images-btn">üîÑ Refresh Local Images</button>
            </div>
          </div>
          
          <!-- Pull Progress Indicator -->
          <div id="pull-progress-container" class="progress-container hidden">
            <div class="progress-info">
              <span id="pull-progress-text">Preparing pull operation...</span>
              <span id="pull-progress-count" class="progress-count">0/0</span>
            </div>
            <div class="progress-bar-container">
              <div id="pull-progress-bar" class="progress-bar"></div>
            </div>
          </div>
          
          <div class="actions">
            <button class="btn btn-primary" id="test-connectivity-btn">üß™ Test Connectivity</button>
            <button class="btn btn-outline-brand" id="pull-btn">Pull from Xloud</button>
          </div>
        </div>
      </section>

      <!-- TAB 3: REGISTRY MANAGEMENT -->
      <section id="tab-registry" class="tab-pane">
        <!-- Registry Status & Control -->
        <div class="registry-section">
          <h3><i class="fa fa-server"></i> Registry Status & Control</h3>
          <div class="status-row">
            <div class="status-dot" id="registry-dot" aria-hidden="true"></div>
            <div>Status: <span id="registry-status">Checking‚Ä¶</span></div>
          </div>
          <div class="actions">
            <button class="btn btn-success" id="toggle-registry-btn">Run Registry</button>
            <button class="btn btn-outline-muted" id="restart-docker-btn" disabled>Restart Docker</button>
            <button class="btn btn-outline-brand" id="check-status-btn">Re-check Status</button>
          </div>
          <div class="hint">
            Creates/updates <code>/etc/docker/daemon.json</code> with
            <code>"insecure-registries": ["docker-registry:4000"]</code>.
            After writing, restart Docker to apply.
          </div>
        </div>

        <!-- Push Images to Registry -->
        <div class="registry-section">
          <h3><i class="fa fa-upload"></i> Push Images to Registry</h3>
          <p class="hint">
            Push locally available Docker images to the local registry at <code>docker-registry:4000</code>.
            Images will be automatically tagged and pushed to the registry.
          </p>
          
          <!-- Progress Indicator -->
          <div id="push-progress-container" class="progress-container hidden">
            <div class="progress-info">
              <span id="push-progress-text">Preparing push operation...</span>
              <span id="push-progress-count" class="progress-count">0/0</span>
            </div>
            <div class="progress-bar-container">
              <div id="push-progress-bar" class="progress-bar"></div>
            </div>
          </div>
          
          <div class="actions">
            <button class="btn btn-brand" id="push-btn">
              <i class="fa fa-upload"></i> Push Images
            </button>
          </div>
        </div>

        <!-- Registry Catalog & Contents -->
        <div class="registry-section">
          <h3><i class="fa fa-list"></i> Registry Catalog & Contents</h3>
          <p class="hint">
            Browse and inspect images stored in the local registry.
          </p>
          <div class="actions">
            <button class="btn btn-outline-brand" id="refresh-catalog-btn">
              <i class="fa fa-refresh"></i> Refresh Catalog
            </button>
          </div>
          <div class="catalog-container">
            <ul id="catalog" class="catalog-list">
              <li>Click "Refresh Catalog" to load registry contents</li>
            </ul>
          </div>
        </div>

        <!-- Registry Administration -->
        <div class="registry-section">
          <h3><i class="fa fa-database"></i> Registry Administration</h3>
          <p class="hint">
            Advanced registry operations. <strong>Warning:</strong> Destructive operations cannot be undone.
          </p>
          
          <div class="registry-actions">
            <div class="action-group">
              <h4><i class="fa fa-info-circle"></i> Registry Information</h4>
              <div class="actions">
                <button class="btn btn-outline-brand" id="registry-info-btn">Show Registry Info</button>
                <button class="btn btn-outline-secondary" id="registry-storage-btn">Show Storage Usage</button>
              </div>
            </div>
            
            <div class="action-group danger-section">
              <h4><i class="fa fa-exclamation-triangle"></i> Danger Zone</h4>
              <div class="danger-warning">
                <strong>‚ö†Ô∏è Destructive Operations:</strong> These actions will permanently delete data.
              </div>
              <div class="actions">
                <button class="btn btn-outline-warning" id="clear-registry-content-btn">Clear Registry Content</button>
                <button class="btn btn-outline-danger" id="delete-entire-registry-btn">Delete Entire Registry</button>
              </div>
              <div class="hint">
                <strong>Clear Content:</strong> Removes all images but keeps registry container.<br>
                <strong>Delete Registry:</strong> Removes container, volumes, and all data permanently.
              </div>
            </div>
          </div>
          
          <details class="config-details">
            <summary>Registry Details</summary>
            <pre id="registry-details" class="config-display">Click "Show Registry Info" to load details</pre>
          </details>
        </div>
      </section>

      <!-- TAB 4: LOGS -->
      <section id="tab-logs" class="tab-pane">
        <div class="card">
          <strong>Execution Log</strong>
          <pre class="yaml-terminal" id="log"></pre>
          <div class="footer-actions">
            <button class="btn btn-outline-muted" id="btn-clear-log" type="button">Clear log</button>
          </div>
        </div>
      </section>
    </main>

        <!-- Modal for server file browser -->
        <div id="server-file-modal" class="modal">
          <div class="modal-content">
            <h3><i class="fa fa-folder-open"></i> Browse Server Files</h3>
            
            <!-- Navigation bar -->
            <div class="file-browser-nav">
              <div class="nav-buttons">
                <button class="btn btn-sm btn-outline-secondary" id="nav-home-btn" title="Go to /home">
                  <i class="fa fa-home"></i> Home
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="nav-root-btn" title="Go to /root">
                  <i class="fa fa-user"></i> Root
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="nav-tmp-btn" title="Go to /tmp">
                  <i class="fa fa-folder"></i> Tmp
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="nav-var-btn" title="Go to /var">
                  <i class="fa fa-database"></i> Var
                </button>
              </div>
            </div>
            
            <!-- Breadcrumb path -->
            <div id="server-file-path" class="file-path-breadcrumb"></div>
            
            <ul id="server-file-list"></ul>
            <div class="modal-actions">
              <button class="btn btn-outline-secondary" id="close-server-file-modal" type="button">Cancel</button>
            </div>
          </div>
        </div>    <!-- Status Bar -->
    <div class="status-bar">
      <span id="status-text">Ready</span>
      <span class="status-actions">
        <a href="#" class="status-link" data-tab="tab-logs">View Logs</a>
      </span>
    </div>
  </div>

  <script src="xavs-images.js"></script>
</body>
</html>
