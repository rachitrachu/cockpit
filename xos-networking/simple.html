<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XOS Networking</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Cockpit API -->
  <script src="../base1/cockpit.js"></script>

  <!-- Clean Styles -->
  <link href="clean-style.css" rel="stylesheet">
</head>
<body>
  <div class="xos-container">
    <header class="xos-header">
      <div class="xos-title">
        <svg class="xos-logo" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="2"/>
        </svg>
        <h1>XOS Networking</h1>
      </div>
      <div class="xos-actions">
        <button id="btn-refresh" class="btn primary">Refresh All</button>
      </div>
    </header>

    <nav class="xos-tabs">
      <button class="tab active" data-tab="interfaces">Interfaces</button>
      <button class="tab" data-tab="constructs">VLAN / Bridge / Bond</button>
      <button class="tab" data-tab="diagnostics">Diagnostics</button>
    </nav>

    <main>
      <!-- Interfaces -->
      <section id="tab-interfaces" class="tab-panel active">
        <div class="toolbar">
          <div class="search">
            <input id="search-iface" placeholder="Search interfaces..." />
          </div>
          <div class="spacer"></div>
          <div class="quick-actions">
            <button id="btn-refresh-interfaces" class="btn">Refresh</button>
            <button id="btn-show-netplan" class="btn btn-outline">Show Config</button>
            <button id="btn-apply-netplan" class="btn btn-outline">Apply Config</button>
            <button id="btn-backup-netplan" class="btn btn-outline">Backup</button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table" id="table-interfaces">
            <thead>
              <tr>
                <th>Device</th>
                <th>Type</th>
                <th>State</th>
                <th>MAC</th>
                <th>IPv4</th>
                <th>IPv6</th>
                <th>MTU</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- VLAN/Bridge/Bond -->
      <section id="tab-constructs" class="tab-panel">
        <div class="grid">
          <!-- VLAN -->
          <div class="card">
            <h3>Create VLAN</h3>
            <label>Parent Interface
              <select id="vlan-parent" required></select>
            </label>
            <label>VLAN ID
              <input id="vlan-id" type="number" min="1" max="4094" required placeholder="10">
            </label>
            <label>Interface Name (optional)
              <input id="vlan-name" type="text" placeholder="eth0.10">
            </label>
            <button id="btn-create-vlan" class="btn primary">Create VLAN</button>
            <pre id="vlan-out" class="out"></pre>
          </div>

          <!-- Bridge -->
          <div class="card">
            <h3>Create Bridge</h3>
            <label>Bridge Name
              <input id="br-name" type="text" required placeholder="br0">
            </label>
            <label>Port Interfaces
              <select id="br-ports" multiple required style="height:100px;"></select>
            </label>
            <button id="btn-create-bridge" class="btn primary">Create Bridge</button>
            <pre id="br-out" class="out"></pre>
          </div>

          <!-- Bond -->
          <div class="card">
            <h3>Create Bond</h3>
            <label>Bond Name
              <input id="bond-name" type="text" required placeholder="bond0">
            </label>
            <label>Bonding Mode
              <select id="bond-mode" required>
                <option value="active-backup">Active-Backup</option>
                <option value="balance-rr">Balance Round-Robin</option>
                <option value="balance-xor">Balance XOR</option>
                <option value="802.3ad">802.3ad (LACP)</option>
              </select>
            </label>
            <label>Slave Interfaces
              <select id="bond-slaves" multiple required style="height:100px;"></select>
            </label>
            <button id="btn-create-bond" class="btn primary">Create Bond</button>
            <pre id="bond-out" class="out"></pre>
          </div>
        </div>
      </section>

      <!-- Diagnostics -->
      <section id="tab-diagnostics" class="tab-panel">
        <div class="grid">
          <div class="card">
            <h3>Network Diagnostics</h3>
            <label>Target Host/IP
              <input id="diag-host" placeholder="8.8.8.8" value="8.8.8.8">
            </label>
            <button id="btn-ping" class="btn primary">Ping</button>
            <pre id="ping-out" class="out" style="min-height: 200px;">Click "Ping" to test connectivity...</pre>
          </div>
          <div class="card">
            <h3>Routing Table</h3>
            <pre id="routes-out" class="out" style="min-height: 200px;">Loading routes...</pre>
          </div>
          <div class="card">
            <h3>DNS Configuration</h3>
            <pre id="dns-out" class="out" style="min-height: 200px;">Loading DNS config...</pre>
          </div>
        </div>
      </section>
    </main>

    <footer class="xos-footer">
      <span id="status">Ready</span> | XOS Networking Management Interface
    </footer>
  </div>

  <!-- Simplified JavaScript -->
  <script>
    (() => {
      'use strict';
      
      console.log('XOS Networking starting...');

      // Simple DOM helpers
      const $ = (q) => document.querySelector(q);
      const $$ = (q) => Array.from(document.querySelectorAll(q));

      // Status management
      function setStatus(msg) { 
        const statusEl = $('#status');
        if (statusEl) {
          statusEl.textContent = msg || 'Ready'; 
          console.log('Status:', msg || 'Ready');
        }
      }

      // Command execution
      async function run(cmd, args = [], opts = {}) {
        try {
          console.log('Running command:', cmd, args);
          setStatus(`Running ${cmd}...`);
          
          if (typeof cockpit === 'undefined') {
            throw new Error('Cockpit API not available');
          }
          
          const proc = cockpit.spawn([cmd, ...args], {
            superuser: "try",
            err: "out",
            ...opts
          });
          
          let out = "";
          proc.stream(d => out += d);
          await proc;
          
          console.log(`Command ${cmd} completed`);
          return out.trim();
          
        } catch (e) {
          console.error(`Command failed: ${cmd}`, e);
          setStatus('Ready');
          throw e.toString();
        }
      }

      // Create button helper
      function createButton(label, handler, className = 'btn') {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.className = className;
        
        btn.addEventListener('click', async () => {
          const originalText = btn.textContent;
          try {
            btn.disabled = true;
            btn.textContent = 'Loading...';
            await handler();
          } catch (e) {
            console.error(`${label} failed:`, e);
            alert(`${label} failed: ${e}`);
          } finally {
            btn.disabled = false;
            btn.textContent = originalText;
          }
        });
        
        return btn;
      }

      // Create status badge
      function createStatusBadge(state) {
        const span = document.createElement('span');
        const s = (state || 'unknown').toUpperCase();
        span.className = 'badge ' + (s === 'UP' || s === 'CONNECTED' ? 'state-up'
                          : s === 'DOWN' || s === 'DISCONNECTED' ? 'state-down'
                          : 'state-unknown');
        span.textContent = s;
        return span;
      }

      // Load interfaces
      async function loadInterfaces() {
        console.log('Loading interfaces...');
        setStatus('Loading interfaces...');
        
        const tbody = $('#table-interfaces tbody');
        if (!tbody) return;

        try {
          const output = await run('ip', ['-details', 'addr', 'show']);
          const interfaces = [];
          const blocks = output.split(/\n(?=\d+: )/);
          
          for (const block of blocks) {
            if (!block.trim()) continue;
            
            const lines = block.split('\n');
            const firstLine = lines[0];
            const match = firstLine.match(/^(\d+): ([^:]+):/);
            
            if (match) {
              const dev = match[2];
              let type = 'ethernet', state = 'DOWN', mac = '', ipv4 = '', ipv6 = '', mtu = '1500';
              
              for (const line of lines) {
                if (line.includes('mtu')) {
                  const mtuMatch = line.match(/mtu (\d+)/);
                  if (mtuMatch) mtu = mtuMatch[1];
                }
                if (line.includes('link/')) {
                  const macMatch = line.match(/link\/\w+ ([0-9a-fA-F:]+)/);
                  if (macMatch) mac = macMatch[1];
                  const typeMatch = line.match(/link\/(\w+)/);
                  if (typeMatch) type = typeMatch[1];
                }
                if (line.includes('state')) {
                  const stateMatch = line.match(/state (\w+)/);
                  if (stateMatch) state = stateMatch[1];
                }
                if (line.trim().startsWith('inet ')) {
                  const ipMatch = line.match(/inet ([^\s]+)/);
                  if (ipMatch) ipv4 = ipMatch[1];
                }
                if (line.trim().startsWith('inet6 ')) {
                  const ip6Match = line.match(/inet6 ([^\s]+)/);
                  if (ip6Match && !ip6Match[1].startsWith('fe80')) ipv6 = ip6Match[1];
                }
              }
              
              interfaces.push({ dev, type, state, mac, ipv4, ipv6, mtu });
            }
          }

          // Clear and populate table
          tbody.innerHTML = '';
          
          if (interfaces.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="8" style="text-align: center; padding: 2rem;">No network interfaces found</td>';
            tbody.appendChild(row);
            return;
          }

          // Sort by name
          interfaces.sort((a, b) => a.dev.localeCompare(b.dev));

          // Create table rows
          interfaces.forEach(iface => {
            const row = document.createElement('tr');
            
            // Create action buttons
            const actionsCell = document.createElement('td');
            actionsCell.className = 'actions';
            
            const btnUp = createButton('Up', async () => {
              await run('ip', ['link', 'set', iface.dev, 'up'], { superuser: 'require' });
              await loadInterfaces();
            });
            
            const btnDown = createButton('Down', async () => {
              await run('ip', ['link', 'set', iface.dev, 'down'], { superuser: 'require' });
              await loadInterfaces();
            });
            
            const btnInfo = createButton('Info', async () => {
              const info = await run('ip', ['addr', 'show', iface.dev]);
              alert(`Interface ${iface.dev} details:\n\n${info}`);
            });

            actionsCell.appendChild(btnUp);
            actionsCell.appendChild(btnDown);
            actionsCell.appendChild(btnInfo);
            
            // Create cells
            const cells = [
              iface.dev,
              iface.type,
              createStatusBadge(iface.state),
              iface.mac,
              iface.ipv4,
              iface.ipv6,
              iface.mtu,
              actionsCell
            ];
            
            cells.forEach(content => {
              const cell = document.createElement('td');
              if (typeof content === 'string') {
                cell.textContent = content;
              } else {
                cell.appendChild(content);
              }
              row.appendChild(cell);
            });
            
            tbody.appendChild(row);
          });
          
          setStatus(`Loaded ${interfaces.length} interfaces`);
          
        } catch (e) {
          console.error('Failed to load interfaces:', e);
          tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">Error: ${e}</td></tr>`;
          setStatus('Error loading interfaces');
        }
      }

      // Setup tabs
      function setupTabs() {
        const tabs = $$('.tab');
        const panels = $$('.tab-panel');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const targetId = tab.dataset.tab;
            
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            panels.forEach(p => p.classList.remove('active'));
            const targetPanel = $(`#tab-${targetId}`);
            if (targetPanel) {
              targetPanel.classList.add('active');
            }
          });
        });
      }

      // Setup event handlers
      function setupEventHandlers() {
        // Refresh button
        const refreshBtn = $('#btn-refresh');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', async () => {
            await loadInterfaces();
          });
        }

        const refreshIfacesBtn = $('#btn-refresh-interfaces');
        if (refreshIfacesBtn) {
          refreshIfacesBtn.addEventListener('click', async () => {
            await loadInterfaces();
          });
        }

        // Show netplan config
        const btnShowNetplan = $('#btn-show-netplan');
        if (btnShowNetplan) {
          btnShowNetplan.addEventListener('click', async () => {
            try {
              const config = await run('cat', ['/etc/netplan/99-cockpit.yaml'], { superuser: 'try' });
              alert(`Netplan Configuration:\n\n${config}`);
            } catch (e) {
              alert('No netplan configuration found or error reading file.');
            }
          });
        }

        // Apply netplan
        const btnApplyNetplan = $('#btn-apply-netplan');
        if (btnApplyNetplan) {
          btnApplyNetplan.addEventListener('click', async () => {
            if (!confirm('Apply Netplan configuration? This may disrupt network connectivity.')) return;
            try {
              await run('netplan', ['apply'], { superuser: 'require' });
              alert('Netplan configuration applied successfully!');
              await loadInterfaces();
            } catch (e) {
              alert(`Failed to apply Netplan configuration: ${e}`);
            }
          });
        }

        // Backup netplan
        const btnBackupNetplan = $('#btn-backup-netplan');
        if (btnBackupNetplan) {
          btnBackupNetplan.addEventListener('click', async () => {
            try {
              const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
              const backupFile = `/tmp/netplan-backup-${timestamp}.tar.gz`;
              await run('tar', ['-czf', backupFile, '-C', '/etc', 'netplan/'], { superuser: 'require' });
              alert(`Backup created: ${backupFile}`);
            } catch (e) {
              alert(`Backup failed: ${e}`);
            }
          });
        }

        // Ping
        const btnPing = $('#btn-ping');
        if (btnPing) {
          btnPing.addEventListener('click', async () => {
            const host = $('#diag-host').value || '8.8.8.8';
            const output = $('#ping-out');
            try {
              output.textContent = 'Pinging...';
              const result = await run('ping', ['-c', '4', host]);
              output.textContent = result;
            } catch (e) {
              output.textContent = `Ping failed: ${e}`;
            }
          });
        }
      }

      // Initialize
      async function init() {
        console.log('Initializing XOS Networking...');
        
        // Wait for DOM
        if (document.readyState === 'loading') {
          await new Promise(resolve => {
            document.addEventListener('DOMContentLoaded', resolve);
          });
        }

        // Wait for Cockpit
        if (typeof cockpit === 'undefined') {
          await new Promise(resolve => {
            const check = () => {
              if (typeof cockpit !== 'undefined') {
                resolve();
              } else {
                setTimeout(check, 100);
              }
            };
            check();
          });
        }

        setupTabs();
        setupEventHandlers();
        await loadInterfaces();
        
        setStatus('Ready');
        console.log('XOS Networking initialized');
      }

      init().catch(e => console.error('Init failed:', e));
    })();
  </script>
</body>
</html>