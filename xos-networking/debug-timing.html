<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>XOS Networking Debug</title>
    <script src="../base1/cockpit.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .success {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        .btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>?? XOS Networking Debug</h1>
    
    <div class="debug-container">
        <h2>Initialization Debug</h2>
        <div id="status" class="status">Starting debug...</div>
        
        <div>
            <button id="btn-check-dom" class="btn">Check DOM</button>
            <button id="btn-check-cockpit" class="btn">Check Cockpit</button>
            <button id="btn-test-interfaces" class="btn">Test Load Interfaces</button>
            <button id="btn-full-debug" class="btn">Full Debug</button>
        </div>
        
        <h3>Debug Log:</h3>
        <div id="debug-log" class="log">Debug starting...\n</div>
    </div>

    <script>
        const log = document.getElementById('debug-log');
        const status = document.getElementById('status');
        
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function setStatus(msg, type = 'status') {
            status.textContent = msg;
            status.className = `status ${type}`;
        }
        
        // Check DOM elements
        document.getElementById('btn-check-dom').addEventListener('click', () => {
            debugLog('=== DOM CHECK ===');
            debugLog(`Document ready state: ${document.readyState}`);
            
            const elements = [
                '#table-interfaces tbody',
                '#status',
                '#btn-refresh',
                '#vlan-parent',
                '#br-ports',
                '#bond-slaves'
            ];
            
            elements.forEach(selector => {
                const element = document.querySelector(selector);
                debugLog(`${selector}: ${element ? '? Found' : '? Not found'}`);
            });
            
            debugLog('DOM check complete');
        });
        
        // Check Cockpit API
        document.getElementById('btn-check-cockpit').addEventListener('click', () => {
            debugLog('=== COCKPIT API CHECK ===');
            debugLog(`Cockpit available: ${typeof cockpit !== 'undefined' ? '? Yes' : '? No'}`);
            
            if (typeof cockpit !== 'undefined') {
                debugLog(`Cockpit.spawn available: ${typeof cockpit.spawn === 'function' ? '? Yes' : '? No'}`);
                debugLog(`Cockpit.file available: ${typeof cockpit.file === 'function' ? '? Yes' : '? No'}`);
            }
            
            debugLog('Cockpit check complete');
        });
        
        // Test interface loading
        document.getElementById('btn-test-interfaces').addEventListener('click', async () => {
            debugLog('=== INTERFACE LOADING TEST ===');
            
            if (typeof cockpit === 'undefined') {
                debugLog('? Cockpit API not available');
                return;
            }
            
            try {
                debugLog('Testing basic command...');
                const testResult = await cockpit.spawn(['echo', 'test'], { superuser: 'try' });
                debugLog(`? Basic command test: ${testResult.trim()}`);
                
                debugLog('Running ip command...');
                const proc = cockpit.spawn(['ip', '-details', 'addr', 'show'], { superuser: 'try', err: 'out' });
                let output = '';
                
                proc.stream(data => {
                    output += data;
                });
                
                await proc;
                debugLog(`? IP command completed, output length: ${output.length}`);
                debugLog(`First 200 chars: ${output.substring(0, 200)}...`);
                
                // Parse interfaces
                const blocks = output.split(/\n(?=\d+: )/);
                debugLog(`Found ${blocks.length} interface blocks`);
                
                const interfaces = [];
                for (const block of blocks) {
                    if (!block.trim()) continue;
                    const lines = block.split('\n');
                    const firstLine = lines[0];
                    const match = firstLine.match(/^(\d+): ([^:]+):/);
                    if (match) {
                        interfaces.push(match[2]);
                    }
                }
                
                debugLog(`Parsed interfaces: ${interfaces.join(', ')}`);
                setStatus(`Found ${interfaces.length} interfaces`, 'success');
                
            } catch (error) {
                debugLog(`? Interface loading failed: ${error}`);
                setStatus('Interface loading failed', 'error');
            }
        });
        
        // Full debug
        document.getElementById('btn-full-debug').addEventListener('click', async () => {
            debugLog('=== FULL DEBUG STARTED ===');
            
            // Check timing
            debugLog('Checking timing...');
            const startTime = Date.now();
            
            // Simulate the initialization process
            try {
                // Wait for ready (simplified)
                let domReady = document.readyState === 'complete' || document.readyState === 'interactive';
                let cockpitReady = typeof cockpit !== 'undefined';
                
                debugLog(`DOM ready: ${domReady}`);
                debugLog(`Cockpit ready: ${cockpitReady}`);
                
                if (!domReady || !cockpitReady) {
                    debugLog('?? Not ready, would wait...');
                }
                
                // Check for XOS networking main page elements
                const hasMainElements = !!parent.document.querySelector('#table-interfaces tbody');
                debugLog(`Main page elements in parent: ${hasMainElements ? '? Found' : '? Not found'}`);
                
                if (hasMainElements) {
                    debugLog('? Main XOS Networking page detected');
                    
                    // Try to load interfaces in main page context
                    if (parent.window.loadInterfaces) {
                        debugLog('Found loadInterfaces function in parent');
                        await parent.window.loadInterfaces();
                        debugLog('? Interface loading triggered in main page');
                    } else {
                        debugLog('? loadInterfaces function not found in parent');
                    }
                }
                
                const endTime = Date.now();
                debugLog(`Debug completed in ${endTime - startTime}ms`);
                setStatus('Full debug complete', 'success');
                
            } catch (error) {
                debugLog(`? Full debug failed: ${error}`);
                setStatus('Full debug failed', 'error');
            }
        });
        
        // Auto-start debug
        debugLog('Debug page loaded');
        debugLog(`Current URL: ${window.location.href}`);
        debugLog(`Parent URL: ${parent !== window ? parent.location.href : 'Same window'}`);
        setStatus('Debug ready - click buttons to test');
    </script>
</body>
</html>